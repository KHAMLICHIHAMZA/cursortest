// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  SUPER_ADMIN
  COMPANY_ADMIN
  AGENCY_MANAGER
  AGENT
}

enum VehicleStatus {
  AVAILABLE         // Disponible
  RESERVED          // Réservé (booking CONFIRMED, pas encore livré)
  RENTED            // Loué (en location active)
  IN_DELIVERY       // En livraison (check-in en cours) - spec
  IN_RECOVERY       // En récupération (check-out en cours) - spec
  MAINTENANCE       // En maintenance
  UNAVAILABLE       // Non disponible
  TEMP_UNAVAILABLE  // Temporairement indisponible
}

enum BookingStatus {
  DRAFT
  PENDING
  CONFIRMED
  IN_PROGRESS
  EXTENDED // Prolongation (ajout pour compléter les états métier)
  LATE
  RETURNED
  CANCELLED
  NO_SHOW
}

enum MaintenanceStatus {
  PLANNED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum PlanningEventType {
  BOOKING
  MAINTENANCE
  BLOCKAGE
  PREPARATION_TIME
}

enum DocumentType {
  ID_CARD
  DRIVING_LICENSE
  VEHICLE_REGISTRATION
  INSURANCE
  PHOTO
  CONTRACT
  INVOICE
  OTHER
}

enum IncidentType {
  DAMAGE
  FINE
  ACCIDENT
  THEFT
  OTHER
}

enum IncidentStatus {
  REPORTED
  UNDER_REVIEW
  RESOLVED
  DISPUTED
}

enum DepositDecisionSource {
  COMPANY
  AGENCY
}

enum DepositStatusCheckIn {
  PENDING
  COLLECTED
}

enum DepositStatusFinal {
  REFUNDED
  PARTIAL
  FORFEITED
  DISPUTED
}

enum InvoiceStatus {
  ISSUED
  PAID
  CANCELLED
}

// V2: Invoice type (facture / avoir)
enum InvoiceType {
  INVOICE
  CREDIT_NOTE
}

// V2: BookingNumber mode (AUTO/MANUAL) configuré au niveau Company
enum BookingNumberMode {
  AUTO
  MANUAL
}

// V2: Outbox interne pour Domain Events (backbone)
enum OutboxEventStatus {
  PENDING
  PROCESSED
  FAILED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
  PARTIAL
}

enum PaymentMethod {
  ONLINE_CMI
  CASH
  BANK_TRANSFER
  OTHER
}

enum NotificationChannel {
  EMAIL
  WHATSAPP
  PUSH
  SMS
}

enum NotificationType {
  TRANSACTIONAL
  MARKETING
  SYSTEM
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  EXPORT
  IMPORT
  PAYMENT
  BOOKING_STATUS_CHANGE
  OTHER
}

// ============================================
// SAAS ENUMS - Facturation et Modules
// ============================================

// Statut d'une Company dans le cycle de vie SaaS
// ACTIVE: Company active et opérationnelle
// SUSPENDED: Company suspendue (paiement non reçu, restauration possible jusqu'à J+90)
// DELETED: Company supprimée définitivement (soft delete irréversible après J+100)
enum CompanyStatus {
  ACTIVE
  SUSPENDED
  DELETED
}

// Statut d'une Agency dans le cycle de vie SaaS
// ACTIVE: Agency active et opérationnelle
// SUSPENDED: Agency suspendue (hérite du statut Company ou suspension spécifique)
// DELETED: Agency supprimée définitivement (soft delete)
enum AgencyStatus {
  ACTIVE
  SUSPENDED
  DELETED
}

// Statut d'un abonnement (Subscription)
// ACTIVE: Abonnement actif et payé
// SUSPENDED: Abonnement suspendu (paiement en retard)
// EXPIRED: Abonnement expiré (non renouvelé)
// CANCELLED: Abonnement annulé manuellement
enum SubscriptionStatus {
  ACTIVE
  SUSPENDED
  EXPIRED
  CANCELLED
}

// Forme juridique d'une Company
enum CompanyLegalForm {
  SARL
  SAS
  SA
  EI
  AUTO_ENTREPRENEUR
  ASSOCIATION
  AUTRE
}

// Codes des modules SaaS disponibles
// Chaque module peut être activé/désactivé indépendamment
// Dépendances gérées via ModuleDependency
enum ModuleCode {
  VEHICLES // Gestion des véhicules
  BOOKINGS // Gestion des réservations
  INVOICES // Facturation clients
  MAINTENANCE // Gestion maintenance
  FINES // Gestion amendes
  ANALYTICS // Analytics et rapports
}

// Périodicité de facturation SaaS
// MONTHLY: Mensuel
// QUARTERLY: Trimestriel
// YEARLY: Annuel
enum BillingPeriod {
  MONTHLY
  QUARTERLY
  YEARLY
}

// Permissions d'un User sur une Agency
// READ: Lecture seule
// WRITE: Lecture + Écriture (pas de suppression)
// FULL: Lecture + Écriture + Suppression
enum UserAgencyPermission {
  READ
  WRITE
  FULL
}

// ============================================
// CORE MODELS
// ============================================

model Company {
  id       String  @id @default(cuid())
  name     String
  slug     String  @unique
  raisonSociale  String @default("")
  identifiantLegal String? @unique
  formeJuridique CompanyLegalForm @default(AUTRE)
  phone    String?
  address  String?
  isActive Boolean @default(true) // ⚠️ CONSERVÉ pour rétrocompatibilité

  // SaaS: Cycle de vie et statut
  status          CompanyStatus @default(ACTIVE) // Statut SaaS (ACTIVE, SUSPENDED, DELETED)
  suspendedAt     DateTime? // Date de suspension (date pivot pour J+90 et J+100)
  suspendedReason String? // Raison de la suspension

  // SaaS: Configuration métier
  currency String @default("MAD") // Devise par Company (ex: MAD, EUR, USD)
  maxAgencies Int? @default(5) // Null = illimité

  // V2: BookingNumber
  bookingNumberMode BookingNumberMode @default(AUTO)

  // Branding
  logoUrl        String?
  secondaryColor String? // Couleur secondaire pour branding
  faviconUrl     String?

  // Soft delete
  deletedAt DateTime?

  // Enterprise: Audit fields (auto-populated by backend, never editable from frontend)
  createdByUserId String?
  updatedByUserId String?
  deletedByUserId String?
  deletedReason   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  agencies                Agency[]
  bookings                Booking[]
  bookingNumberSequences  BookingNumberSequence[]
  invoices                Invoice[]
  invoiceNumberSequences  InvoiceNumberSequence[]
  users                   User[]
  businessRules           BusinessRule[]
  auditLogs               AuditLog[]
  businessEventLogs       BusinessEventLog[]
  subscriptions           Subscription[]
  companyModules          CompanyModule[]
  notificationPreferences NotificationPreference[]
  PaymentSaas             PaymentSaas[]
  charges                 Charge[]

  @@index([slug])
  @@index([isActive])
  @@index([status])
  @@index([suspendedAt])
  @@index([deletedAt])
}

model Agency {
  id        String  @id @default(cuid())
  name      String
  companyId String
  phone     String?
  address   String?

  // SaaS: Cycle de vie et statut
  status          AgencyStatus @default(ACTIVE) // Statut SaaS (ACTIVE, SUSPENDED, DELETED)
  suspendedAt     DateTime? // Date de suspension
  suspendedReason String? // Raison de la suspension

  // SaaS: Configuration métier
  timezone String @default("Africa/Casablanca") // Fuseau horaire par Agency
  capacity Int? // Capacité maximale (nombre de véhicules, utilisateurs, etc.)
  preparationTimeMinutes Int @default(60) // Temps de préparation après retour (en minutes, > 0)

  // Soft delete
  deletedAt DateTime?

  // Enterprise: Audit fields (auto-populated by backend, never editable from frontend)
  createdByUserId String?
  updatedByUserId String?
  deletedByUserId String?
  deletedReason   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company           Company            @relation(fields: [companyId], references: [id], onDelete: Cascade)
  vehicles          Vehicle[]
  bookings          Booking[]
  fines             Fine[]
  maintenance       Maintenance[]
  clients           Client[]
  userAgencies      UserAgency[]
  incidents         Incident[]
  payments          Payment[]
  businessRules     BusinessRule[]
  planningEvents    PlanningEvent[]
  businessEventLogs BusinessEventLog[]
  agencyModules     AgencyModule[]
  invoices          Invoice[]
  charges           Charge[]

  @@index([companyId])
  @@index([status])
  @@index([suspendedAt])
  @@index([deletedAt])
}

model User {
  id        String  @id @default(cuid())
  email     String  @unique
  password  String
  name      String
  role      Role
  companyId String?
  isActive  Boolean @default(true)

  // 2FA
  twoFactorSecret  String?
  twoFactorEnabled Boolean @default(false)

  // Soft delete
  deletedAt DateTime?

  // Enterprise: Audit fields (auto-populated by backend, never editable from frontend)
  createdByUserId String?
  updatedByUserId String?
  deletedByUserId String?
  deletedReason   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company             Company?             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  userAgencies        UserAgency[]
  passwordResetTokens PasswordResetToken[]
  refreshTokens       RefreshToken[]
  auditLogs           AuditLog[]
  inAppNotifications  InAppNotification[]
  deviceTokens        DeviceToken[]

  @@index([email])
  @@index([companyId])
  @@index([role])
  @@index([deletedAt])
}

model UserAgency {
  id       String @id @default(cuid())
  userId   String
  agencyId String

  // SaaS: Permissions par agence
  permission UserAgencyPermission @default(FULL) // Permission sur cette agence (READ, WRITE, FULL)

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  agency Agency @relation(fields: [agencyId], references: [id], onDelete: Cascade)

  @@unique([userId, agencyId])
  @@index([userId])
  @@index([agencyId])
  @@index([permission])
}

// ============================================
// VEHICLE MODELS
// ============================================

model Vehicle {
  id                 String        @id @default(cuid())
  agencyId           String
  registrationNumber String
  brand              String
  model              String
  year               Int
  mileage            Int           @default(0)
  fuel               String?
  gearbox            String?
  dailyRate          Float
  depositAmount      Float
  status             VehicleStatus @default(AVAILABLE)
  imageUrl           String? // URL de l'image du véhicule
  horsepower         Int? // Puissance en CV
  color              String? // Couleur du véhicule

  // Informations financieres / amortissement
  purchasePrice     Float?    // Prix d'achat du vehicule
  acquisitionDate   DateTime? // Date d'acquisition
  amortizationYears Int?      @default(5) // Duree d'amortissement en annees

  // Mode de financement
  financingType           String?   // CASH | CREDIT | MIXED (comptant, credit total, mixte)
  downPayment             Float?    // Apport / avance initiale (MAD)
  monthlyPayment          Float?    // Mensualite du credit (MAD)
  financingDurationMonths Int?      // Duree du credit en mois
  creditStartDate         DateTime? // Date debut du credit

  // GPS Tracker (boitier physique type mini GPS / AirTag)
  gpsTrackerId    String?   // Identifiant / numero de serie du tracker
  gpsTrackerLabel String?   // Description (ex: "Mini GPS noir coffre")

  // Audit fields (auto-populated by backend, never editable from frontend)
  createdByUserId String?
  updatedByUserId String?
  deletedByUserId String?
  deletedReason   String?

  // Soft delete
  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  agency         Agency          @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  bookings       Booking[]
  maintenance    Maintenance[]
  documents      Document[]
  incidents      Incident[]
  planningEvents PlanningEvent[]
  gpsSnapshots   GpsSnapshot[]
  charges        Charge[]

  @@index([agencyId])
  @@index([status])
  @@index([registrationNumber])
  @@index([deletedAt])
}

// ============================================
// CLIENT MODELS
// ============================================

model Client {
  id              String  @id @default(cuid())
  agencyId        String
  name            String
  email           String?
  phone           String?
  dateOfBirth     DateTime?
  note            String?
  licenseImageUrl String? // URL de l'image du permis de conduite

  // Nationalité et origine
  isMoroccan      Boolean @default(true) // Si le client est marocain
  countryOfOrigin String? // Pays d'origine si non marocain

  // Informations du permis de conduite
  licenseNumber     String? // Numéro du permis
  licenseType       String? // Type de permis
  licenseExpiryDate DateTime // Date de validité du permis (NOT NULL - obligatoire)
  isForeignLicense  Boolean   @default(false) // Si le permis est étranger

  // Pièce d'identité (pour non-marocains ou marocains résidant à l'étranger)
  idCardType         String? // Type de pièce d'identité (CIN, CARTE_SEJOUR, TITRE_SEJOUR, PERMIS_RESIDENCE, AUTRE)
  idCardNumber       String? // Numéro de pièce d'identité
  idCardExpiryDate   DateTime? // Date d'expiration de la pièce d'identité
  passportNumber     String? // Numéro de passeport
  passportExpiryDate DateTime? // Date d'expiration du passeport

  // Conformité
  isCompliant         Boolean   @default(false)
  complianceCheckedAt DateTime?

  // Audit fields (auto-populated by backend, never editable from frontend)
  createdByUserId String?
  updatedByUserId String?
  deletedByUserId String?
  deletedReason   String?

  // Soft delete
  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  agency    Agency     @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  bookings  Booking[]
  documents Document[]
  incidents Incident[]

  @@index([agencyId])
  @@index([deletedAt])
  @@index([isCompliant])
}

// ============================================
// BOOKING MODELS
// ============================================

model Booking {
  id         String        @id @default(cuid())
  agencyId   String
  companyId  String
  vehicleId  String
  clientId   String
  startDate  DateTime
  endDate    DateTime
  totalPrice Float
  status     BookingStatus @default(DRAFT)

  // V2: BookingNumber (unique par Company)
  bookingNumber String

  // Prolongation
  originalEndDate DateTime? // Date de fin originale si prolongation
  extensionDays   Int? // Nombre de jours de prolongation

  // Swap véhicule
  swappedFromVehicleId String?
  swapReason           String?

  // Caution (définie à la réservation)
  depositRequired        Boolean              @default(false)
  depositAmount          Decimal?             @db.Decimal(10, 2)
  depositDecisionSource  DepositDecisionSource?
  depositStatusCheckIn   DepositStatusCheckIn @default(PENDING)
  depositStatusFinal     DepositStatusFinal?

  // Frais de retard
  lateFeeAmount              Decimal?  @db.Decimal(10, 2)
  lateFeeCalculatedAt        DateTime?
  lateFeeOverride            Boolean   @default(false)
  lateFeeOverrideJustification String? @db.Text
  lateFeeOverrideBy           String?
  lateFeeOverrideAt          DateTime?

  // Clôture financière
  financialClosureBlocked        Boolean @default(false)
  financialClosureBlockedReason  String? @db.Text

  // Audit fields (auto-populated by backend, never editable from frontend)
  createdByUserId String?
  updatedByUserId String?
  deletedByUserId String?
  deletedReason   String?

  // Soft delete
  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  agency         Agency          @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  company        Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  vehicle        Vehicle         @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  client         Client          @relation(fields: [clientId], references: [id], onDelete: Cascade)
  fines          Fine[]
  payments       Payment[]
  incidents      Incident[]
  documents      Document[]
  planningEvents PlanningEvent[]
  invoices       Invoice[]
  contracts      Contract[]
  gpsSnapshots   GpsSnapshot[]

  @@index([agencyId])
  @@index([companyId])
  @@index([vehicleId])
  @@index([clientId])
  @@index([status])
  @@index([startDate])
  @@index([endDate])
  @@index([deletedAt])

  @@unique([companyId, bookingNumber])
}

// V2: séquence BookingNumber par Company + année (reset annuel)
model BookingNumberSequence {
  id String @id @default(cuid())

  companyId String
  year      Int
  lastValue Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, year])
  @@index([companyId])
  @@index([year])
}

// ============================================
// PLANNING MODELS (SOURCE DE VÉRITÉ)
// ============================================

model PlanningEvent {
  id            String  @id @default(cuid())
  agencyId      String
  vehicleId     String?
  bookingId     String?
  maintenanceId String?

  type        PlanningEventType
  title       String
  description String?

  startDate DateTime
  endDate   DateTime

  // Temps de préparation
  isPreparationTime Boolean @default(false)
  isLate            Boolean @default(false) // Si créé après retard

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  agency      Agency       @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  vehicle     Vehicle?     @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  booking     Booking?     @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  maintenance Maintenance? @relation(fields: [maintenanceId], references: [id], onDelete: Cascade)

  @@index([agencyId])
  @@index([vehicleId])
  @@index([bookingId])
  @@index([startDate])
  @@index([endDate])
  @@index([type])
}

// ============================================
// MAINTENANCE MODELS
// ============================================

model Maintenance {
  id          String            @id @default(cuid())
  agencyId    String
  vehicleId   String
  description String
  plannedAt   DateTime?
  cost        Float?
  status      MaintenanceStatus @default(PLANNED)
  documentUrl String? // URL de la facture ou du devis

  // Audit fields (auto-populated by backend, never editable from frontend)
  createdByUserId String?
  updatedByUserId String?
  deletedByUserId String?
  deletedReason   String?

  // Soft delete
  deletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  agency         Agency          @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  vehicle        Vehicle         @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  documents      Document[]
  planningEvents PlanningEvent[]

  @@index([agencyId])
  @@index([vehicleId])
  @@index([status])
  @@index([plannedAt])
  @@index([deletedAt])
}

// ============================================
// INCIDENT MODELS
// ============================================

model Incident {
  id       String         @id @default(cuid())
  agencyId String
  type     IncidentType
  status   IncidentStatus @default(REPORTED)

  // Relations
  bookingId String?
  vehicleId String?
  clientId  String?

  title       String
  description String
  amount      Float? // Pour amendes

  // Résolution
  resolvedAt DateTime?
  resolvedBy String? // User ID
  resolution String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  agency    Agency     @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  booking   Booking?   @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  vehicle   Vehicle?   @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  client    Client?    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  documents Document[]

  @@index([agencyId])
  @@index([bookingId])
  @@index([vehicleId])
  @@index([status])
  @@index([type])
}

// ============================================
// FINE (AMENDES) MODELS
// ============================================

// Statuts amendes selon spec: reçue → client identifié → transmise → contestée → clôturée
enum FineStatus {
  RECUE             // Amende reçue par l'agence
  CLIENT_IDENTIFIE  // Client responsable identifié automatiquement
  TRANSMISE         // Amende transmise au client
  CONTESTEE         // Client conteste l'amende
  CLOTUREE          // Amende traitée (payée ou annulée)
}

model Fine {
  id                  String     @id @default(cuid())
  agencyId            String
  bookingId           String?    // Peut être null si auto-identification échoue
  amount              Float
  description         String
  number              String?    // Référence de l'amende (numéro officiel)
  location            String?    // Lieu de l'infraction
  attachmentUrl       String?    // URL de la pièce jointe
  
  // Champs spec amendes (saisie minimale)
  infractionDate      DateTime?  // Date d'infraction (spec: donnée minimale)
  registrationNumber  String?    // N° immatriculation (spec: donnée minimale pour auto-identification)
  
  // Statut selon spec
  status              FineStatus @default(RECUE)
  
  // Client identifié automatiquement
  clientId            String?    // Client principal identifié
  secondaryDriverId   String?    // Conducteur secondaire si existant

  // Audit fields (auto-populated by backend, never editable from frontend)
  createdByUserId String?
  updatedByUserId String?
  deletedByUserId String?
  deletedReason   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  agency  Agency   @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  booking Booking? @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([agencyId])
  @@index([bookingId])
  @@index([status])
  @@index([infractionDate])
  @@index([registrationNumber])
}

// ============================================
// DOCUMENT MODELS
// ============================================

model Document {
  id          String       @id @default(cuid())
  type        DocumentType
  title       String
  description String?

  // Stockage S3
  url      String // URL S3
  key      String // Key S3
  size     Int? // Taille en bytes
  mimeType String?

  // Relations (polymorphique)
  clientId      String?
  vehicleId     String?
  bookingId     String?
  maintenanceId String?
  incidentId    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  client      Client?      @relation(fields: [clientId], references: [id], onDelete: Cascade)
  vehicle     Vehicle?     @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  booking     Booking?     @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  maintenance Maintenance? @relation(fields: [maintenanceId], references: [id], onDelete: Cascade)
  incident    Incident?    @relation(fields: [incidentId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([vehicleId])
  @@index([bookingId])
  @@index([type])
}

// ============================================
// PAYMENT MODELS
// ============================================

model Payment {
  id        String @id @default(cuid())
  agencyId  String
  bookingId String

  amount Float
  method PaymentMethod
  status PaymentStatus @default(PENDING)

  // CMI
  cmiTransactionId String?
  cmiResponse      Json? // Réponse complète CMI

  // Acompte ou total
  isDeposit     Boolean @default(false)
  depositAmount Float? // Si acompte

  // Caution
  depositHeld     Float? // Caution retenue
  depositReturned Float? // Caution retournée

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  agency  Agency  @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([agencyId])
  @@index([bookingId])
  @@index([status])
  @@index([cmiTransactionId])
}

// ============================================
// INVOICE MODELS
// ============================================

model Invoice {
  id           String        @id @default(cuid())
  companyId    String
  agencyId     String
  bookingId    String
  invoiceNumber String       // V2: séquence par company + reset annuel (unique via @@unique below)
  type         InvoiceType   @default(INVOICE)
  year         Int
  sequence     Int
  issuedAt     DateTime
  totalAmount  Decimal       @db.Decimal(10, 2)
  status       InvoiceStatus @default(ISSUED)

  // V2: payload figé (source de vérité pour rendu PDF)
  payload Json

  // V2: relations de correction
  originalInvoiceId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  agency  Agency  @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  originalInvoice Invoice? @relation("InvoiceCorrections", fields: [originalInvoiceId], references: [id], onDelete: SetNull)
  correctiveInvoices Invoice[] @relation("InvoiceCorrections")

  @@index([companyId])
  @@index([agencyId])
  @@index([bookingId])
  @@index([invoiceNumber])
  @@index([type])
  @@index([year])
  @@index([sequence])
  @@index([status])
  @@index([issuedAt])

  @@unique([companyId, year, sequence])
}

// V2: séquence InvoiceNumber par Company + année (reset annuel)
model InvoiceNumberSequence {
  id String @id @default(cuid())

  companyId String
  year      Int
  lastValue Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, year])
  @@index([companyId])
  @@index([year])
}

// ============================================
// V2 OUTBOX EVENTS (DOMAIN EVENTS BACKBONE)
// ============================================
model OutboxEvent {
  id String @id @default(cuid())

  // Aggregate
  aggregateType String
  aggregateId   String

  // Event
  eventType String
  payload   Json

  // Optional deduplication / idempotency key
  deduplicationKey String? @unique

  // Processing
  status      OutboxEventStatus @default(PENDING)
  attempts    Int              @default(0)
  availableAt DateTime         @default(now())
  processedAt DateTime?
  lastError   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([aggregateType, aggregateId])
  @@index([status, availableAt])
  @@index([eventType])
}

// ============================================
// V2 CONTRACT MODELS
// ============================================

enum ContractStatus {
  DRAFT
  PENDING_SIGNATURE
  SIGNED
  EXPIRED
  CANCELLED
}

enum SignerType {
  CLIENT
  AGENT
}

model Contract {
  id        String         @id @default(cuid())
  bookingId String
  agencyId  String
  companyId String

  // Template versioning
  templateId      String?
  templateVersion Int      @default(1)

  // Status
  status ContractStatus @default(DRAFT)

  // Content (frozen at creation)
  payload Json

  // Signatures
  clientSignedAt    DateTime?
  clientSignature   String?   @db.Text // Base64 encoded signature image
  clientSignedDevice String?  // Device info for audit

  agentSignedAt    DateTime?
  agentSignature   String?   @db.Text // Base64 encoded signature image
  agentSignedDevice String?  // Device info for audit
  agentUserId      String?   // Agent who signed

  // Version control
  version         Int       @default(1)
  previousVersion String?   // ID of previous contract version
  versionReason   String?   // Reason for new version

  // Timestamps
  effectiveAt DateTime? // Becomes effective at check-in
  expiresAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([bookingId])
  @@index([agencyId])
  @@index([companyId])
  @@index([status])
  @@index([version])
}

model ContractTemplate {
  id        String @id @default(cuid())
  companyId String
  name      String
  content   String @db.Text // Template content (Handlebars/HTML)
  version   Int    @default(1)
  isActive  Boolean @default(true)
  isDefault Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@index([isActive])
  @@index([isDefault])
}

// ============================================
// V2 JOURNAL D'AGENCE (PROJECTION)
// ============================================

enum JournalEntryType {
  BOOKING_CREATED
  BOOKING_UPDATED
  BOOKING_CANCELLED
  CHECK_IN
  CHECK_OUT
  INVOICE_ISSUED
  CREDIT_NOTE_ISSUED
  CONTRACT_CREATED
  CONTRACT_SIGNED
  INCIDENT_REPORTED
  INCIDENT_RESOLVED
  GPS_SNAPSHOT
  MANUAL_NOTE
  SYSTEM_EVENT
}

model JournalEntry {
  id        String           @id @default(cuid())
  agencyId  String
  companyId String

  // Entry type
  type      JournalEntryType
  title     String
  content   String           @db.Text

  // Relations (optional)
  bookingId       String?
  bookingNumber   String?
  vehicleId       String?
  userId          String?      // Who triggered
  contractId      String?
  invoiceId       String?
  incidentId      String?

  // Metadata
  metadata  Json?

  // For manual notes (only managers can edit)
  isManualNote Boolean @default(false)
  editedAt     DateTime?
  editedBy     String?

  createdAt DateTime @default(now())

  @@index([agencyId])
  @@index([companyId])
  @@index([type])
  @@index([bookingId])
  @@index([bookingNumber])
  @@index([vehicleId])
  @@index([createdAt])
}

// ============================================
// V2 GPS SNAPSHOTS (ECO-FRIENDLY)
// ============================================

enum GpsSnapshotReason {
  CHECK_IN
  CHECK_OUT
  INCIDENT
  MANUAL
}

model GpsSnapshot {
  id        String           @id @default(cuid())
  agencyId  String
  bookingId String?
  vehicleId String?

  // Location data
  latitude  Float
  longitude Float
  accuracy  Float?           // Accuracy in meters
  altitude  Float?

  // Reason
  reason    GpsSnapshotReason

  // For manual captures
  capturedByUserId String?
  capturedByRole   String?  // Role at the time of capture

  // If GPS was unavailable
  isGpsMissing     Boolean @default(false)
  gpsMissingReason String? // 'permissionDenied' | 'offline' | 'deviceUnsupported'

  // Metadata
  deviceInfo String?
  mileage    Int?      // Kilométrage at snapshot time

  createdAt DateTime @default(now())

  booking Booking? @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  vehicle Vehicle? @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@index([agencyId])
  @@index([bookingId])
  @@index([vehicleId])
  @@index([reason])
  @@index([createdAt])
}

// ============================================
// V2 IN-APP NOTIFICATIONS
// ============================================

enum InAppNotificationStatus {
  DRAFT
  SCHEDULED
  SENT
  READ
}

enum InAppNotificationType {
  CONTRACT_TO_SIGN
  INVOICE_AVAILABLE
  BOOKING_LATE
  CHECK_OUT_REMINDER
  INCIDENT_REPORTED
  SYSTEM_ALERT
  ADMIN_ANNOUNCEMENT
}

model InAppNotification {
  id        String                   @id @default(cuid())
  userId    String                   // Recipient user
  companyId String?
  agencyId  String?

  // Notification type
  type      InAppNotificationType
  status    InAppNotificationStatus  @default(DRAFT)

  // Content
  title     String
  message   String                   @db.Text
  actionUrl String?                  // Deep link or URL

  // Relations
  bookingId   String?
  contractId  String?
  invoiceId   String?

  // Scheduling
  scheduledAt DateTime?
  sentAt      DateTime?
  readAt      DateTime?

  // Metadata
  metadata  Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([companyId])
  @@index([agencyId])
  @@index([type])
  @@index([status])
  @@index([sentAt])
  @@index([readAt])
}

// ============================================
// BUSINESS EVENT LOG MODELS
// ============================================

enum BusinessEventType {
  BOOKING_CREATED
  BOOKING_UPDATED
  BOOKING_CANCELLED
  BOOKING_STATUS_CHANGED
  VEHICLE_CREATED
  VEHICLE_UPDATED
  VEHICLE_DELETED
  VEHICLE_STATUS_CHANGED
  CLIENT_CREATED
  CLIENT_UPDATED
  CLIENT_DELETED
  MAINTENANCE_CREATED
  MAINTENANCE_UPDATED
  MAINTENANCE_STATUS_CHANGED
  FINE_CREATED
  FINE_UPDATED
  FINE_DELETED
  COMPANY_CREATED
  COMPANY_UPDATED
  COMPANY_DELETED
  AGENCY_CREATED
  AGENCY_UPDATED
  AGENCY_DELETED
  AGENCY_CREATE_BLOCKED_MAX_LIMIT
  USER_CREATED
  USER_UPDATED
  USER_DELETED
}

model BusinessEventLog {
  id String @id @default(cuid())

  agencyId  String? // Optional for company-level events
  companyId String? // Optional for super-admin level events

  // Entity information
  entityType String // "Booking", "Vehicle", "Client", "Maintenance", "Fine", "Company", "Agency", "User"
  entityId   String

  // Event details
  eventType     BusinessEventType
  previousState Json? // State before the event (for updates)
  newState      Json? // State after the event

  // Who triggered it
  triggeredByUserId String?

  createdAt DateTime @default(now())

  agency  Agency?  @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  company Company? @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([agencyId])
  @@index([companyId])
  @@index([entityType])
  @@index([entityId])
  @@index([eventType])
  @@index([triggeredByUserId])
  @@index([createdAt])
}

// ============================================
// NOTIFICATION MODELS
// ============================================

model Notification {
  id String @id @default(cuid())

  channel   NotificationChannel
  type      NotificationType
  recipient String // Email, phone, user ID selon channel
  subject   String?
  content   String
  metadata  Json? // Données additionnelles

  // Statut
  sent   Boolean   @default(false)
  sentAt DateTime?
  error  String?

  // Opt-in (pour marketing)
  requiresOptIn Boolean @default(false)
  optInConsent  Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([recipient])
  @@index([channel])
  @@index([type])
  @@index([sent])
}

// ============================================
// BUSINESS RULES MODELS
// ============================================

model BusinessRule {
  id        String  @id @default(cuid())
  companyId String?
  agencyId  String?

  key         String // Ex: "preparation_time_standard", "preparation_time_late"
  value       String // Ex: "1h", "2h"
  description String?

  // Versionnement
  version  Int     @default(1)
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company Company? @relation(fields: [companyId], references: [id], onDelete: Cascade)
  agency  Agency?  @relation(fields: [agencyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([agencyId])
  @@index([key])
  @@index([isActive])
}

// ============================================
// AUTH MODELS
// ============================================

model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
}

model RefreshToken {
  id        String    @id @default(cuid())
  userId    String
  token     String    @unique
  expiresAt DateTime
  revoked   Boolean   @default(false)
  revokedAt DateTime?
  createdAt DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@index([revoked])
}

// ============================================
// AUDIT LOGS MODELS
// ============================================

model AuditLog {
  id String @id @default(cuid())

  // Qui
  userId    String?
  companyId String?
  agencyId  String?

  // Quoi
  action     AuditAction
  entityType String? // "Booking", "Vehicle", etc.
  entityId   String?

  // Détails
  description String
  metadata    Json? // Données avant/après, IP, user agent, etc.

  // Contexte
  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())

  user    User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  company Company? @relation(fields: [companyId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([companyId])
  @@index([agencyId])
  @@index([action])
  @@index([entityType])
  @@index([entityId])
  @@index([createdAt])
}

// ============================================
// SAAS MODELS - Facturation et Modules
// ============================================

// Plan d'abonnement SaaS (Starter, Pro, Enterprise)
// Définit les modules inclus et les quotas par défaut
model Plan {
  id          String  @id @default(cuid())
  name        String  @unique // "Starter", "Pro", "Enterprise"
  description String?
  price       Float // Prix mensuel de base
  isActive    Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  planModules   PlanModule[]
  planQuotas    PlanQuota[]
  subscriptions Subscription[]

  @@index([isActive])
}

// Modules inclus dans un Plan
// Définit quels modules sont disponibles dans chaque plan
model PlanModule {
  id         String     @id @default(cuid())
  planId     String
  moduleCode ModuleCode

  plan Plan @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@unique([planId, moduleCode])
  @@index([planId])
  @@index([moduleCode])
}

// Quotas définis dans un Plan
// Limites par défaut (agences, utilisateurs, véhicules, etc.)
model PlanQuota {
  id         String @id @default(cuid())
  planId     String
  quotaKey   String // "max_agencies", "max_users", "max_vehicles", etc.
  quotaValue Int // Valeur du quota (-1 = illimité)

  plan Plan @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@unique([planId, quotaKey])
  @@index([planId])
}

// Abonnement d'une Company
// Un Company peut avoir un seul abonnement actif à la fois
model Subscription {
  id        String @id @default(cuid())
  companyId String @unique
  planId    String

  status        SubscriptionStatus @default(ACTIVE)
  billingPeriod BillingPeriod      @default(MONTHLY)

  // Dates
  startDate   DateTime
  endDate     DateTime
  renewedAt   DateTime? // Date du dernier renouvellement
  cancelledAt DateTime? // Date d'annulation

  // Montant
  amount Float // Montant de l'abonnement (peut différer du plan si modifié)

  // Audit
  createdByUserId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company             Company              @relation(fields: [companyId], references: [id], onDelete: Cascade)
  plan                Plan                 @relation(fields: [planId], references: [id])
  subscriptionModules SubscriptionModule[]
  paymentsSaas        PaymentSaas[]

  @@index([companyId])
  @@index([planId])
  @@index([status])
  @@index([endDate])
}

// Modules activés dans un abonnement
// Liste des modules inclus dans l'abonnement actuel
model SubscriptionModule {
  id             String     @id @default(cuid())
  subscriptionId String
  moduleCode     ModuleCode

  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@unique([subscriptionId, moduleCode])
  @@index([subscriptionId])
  @@index([moduleCode])
}

// Paiements d'abonnement SaaS
// Différent du modèle Payment (qui est pour les paiements de location)
model PaymentSaas {
  id             String @id @default(cuid())
  subscriptionId String
  companyId      String

  amount Float
  status PaymentStatus @default(PENDING)
  method PaymentMethod @default(BANK_TRANSFER) // Manuel uniquement pour V1

  // Paiement en ligne (hooks préparés pour V2)
  onlinePaymentId       String? // ID transaction paiement en ligne (futur)
  onlinePaymentResponse Json? // Réponse complète (futur)

  // Dates
  dueDate DateTime // Date d'échéance
  paidAt  DateTime? // Date de paiement effectif

  // Références
  invoiceNumber String? // Numéro de facture
  invoiceUrl    String? // URL de la facture

  // Audit
  createdByUserId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  company      Company      @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@index([companyId])
  @@index([status])
  @@index([dueDate])
}

// Modules activés au niveau Company
// CompanyModule = modules payés (hérités par toutes les agences)
model CompanyModule {
  id         String     @id @default(cuid())
  companyId  String
  moduleCode ModuleCode

  isActive Boolean @default(true) // Module activé ou désactivé

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, moduleCode])
  @@index([companyId])
  @@index([moduleCode])
  @@index([isActive])
}

// Modules activés au niveau Agency
// AgencyModule = modules actifs (peut désactiver un module Company, mais pas activer un module non payé)
model AgencyModule {
  id         String     @id @default(cuid())
  agencyId   String
  moduleCode ModuleCode

  isActive Boolean @default(true) // Module activé ou désactivé pour cette agence

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  agency Agency @relation(fields: [agencyId], references: [id], onDelete: Cascade)

  @@unique([agencyId, moduleCode])
  @@index([agencyId])
  @@index([moduleCode])
  @@index([isActive])
}

// Dépendances entre modules
// Définit quels modules dépendent d'autres modules
// Ex: BOOKINGS → VEHICLES, INVOICES → BOOKINGS, etc.
model ModuleDependency {
  id            String     @id @default(cuid())
  moduleCode    ModuleCode // Module qui dépend
  dependsOnCode ModuleCode // Module requis

  @@unique([moduleCode, dependsOnCode])
  @@index([moduleCode])
  @@index([dependsOnCode])
}

// ============================================
// V2.1: Charges & KPI
// ============================================

// Types de charges selon spec: assurance, vignette/dariba, mensualité bancaire,
// maintenance préventive/corrective, charges exceptionnelles
enum ChargeCategory {
  INSURANCE             // Assurance (annuelle)
  VIGNETTE              // Vignette / Dariba (annuelle)
  BANK_INSTALLMENT      // Mensualité bancaire (mensuelle)
  PREVENTIVE_MAINTENANCE // Maintenance préventive
  CORRECTIVE_MAINTENANCE // Maintenance corrective
  FUEL                  // Carburant
  EXCEPTIONAL           // Charges exceptionnelles (hors amendes)
  OTHER                 // Autre
}

model Charge {
  id        String         @id @default(cuid())
  companyId String
  agencyId  String
  vehicleId String         // Spec: charge rattachée AU VÉHICULE (obligatoire)
  bookingId String?        // Optionnel: charge liée à une réservation

  category    ChargeCategory
  description String
  amount      Decimal        @db.Decimal(10, 2)
  date        DateTime
  recurring   Boolean        @default(false)
  recurrencePeriod String?   // 'MONTHLY' | 'QUARTERLY' | 'YEARLY'

  // Audit
  createdByUserId String?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  agency  Agency  @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  vehicle Vehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([agencyId])
  @@index([vehicleId])
  @@index([bookingId])
  @@index([category])
  @@index([date])
}

// ============================================
// V2.1: Device Tokens (FCM push notifications)
// ============================================

model DeviceToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  platform  String   // 'ios' | 'android' | 'web'
  isActive  Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([isActive])
}

// Préférences de notification par Company
// Paramétrage des canaux de notification (email, in-app, les deux)
model NotificationPreference {
  id        String @id @default(cuid())
  companyId String @unique

  // Canaux activés
  emailEnabled Boolean @default(true)
  inAppEnabled Boolean @default(true)

  // Types de notifications
  billingNotificationsEmail Boolean @default(true) // Notifications facturation par email
  billingNotificationsInApp Boolean @default(true) // Notifications facturation in-app
  systemNotificationsEmail  Boolean @default(true) // Notifications système par email
  systemNotificationsInApp  Boolean @default(true) // Notifications système in-app

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
}
